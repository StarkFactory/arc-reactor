name: Security Baseline

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  changes:
    name: Security Change Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      dependency_scan: ${{ steps.filter.outputs.dependency_scan }}
    steps:
      - uses: actions/checkout@v6

      - name: Detect Dependency-Related Changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            dependency_scan:
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
              - 'buildSrc/**'
              - '**/build.gradle.kts'
              - '**/gradle.properties'

  secret-scan:
    name: Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Install Gitleaks (OSS CLI)
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.24.2"
          INSTALL_DIR="$RUNNER_TEMP/gitleaks"
          mkdir -p "$INSTALL_DIR"
          curl -sSL \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            -o "$INSTALL_DIR/gitleaks.tar.gz"
          tar -xzf "$INSTALL_DIR/gitleaks.tar.gz" -C "$INSTALL_DIR" gitleaks
          chmod +x "$INSTALL_DIR/gitleaks"
          echo "$INSTALL_DIR" >> "$GITHUB_PATH"

      - name: Run Gitleaks (OSS)
        run: |
          gitleaks git \
            --redact \
            --baseline-path .gitleaks-baseline.json \
            --exit-code 1 \
            --report-format sarif \
            --report-path gitleaks.sarif

  dependency-vulnerability-scan:
    name: Dependency Vulnerability Scan (Trivy)
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.dependency_scan == 'true'
    steps:
      - uses: actions/checkout@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle
      - name: Build executable jar for dependency scan
        run: ./gradlew --no-daemon :arc-app:bootJar -Pdb=true -Pauth=true -x test
      - name: Verify scan target exists
        run: ls -1 arc-app/build/libs/*.jar
      - name: Run Grype dependency scan (HIGH/CRITICAL, fixed only)
        uses: anchore/scan-action@v7
        with:
          path: arc-app/build/libs
          fail-build: true
          severity-cutoff: high
          only-fixed: true
