name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v4.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  security-gates:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install Gitleaks (OSS CLI)
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.24.2"
          INSTALL_DIR="$RUNNER_TEMP/gitleaks"
          mkdir -p "$INSTALL_DIR"
          curl -sSL \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            -o "$INSTALL_DIR/gitleaks.tar.gz"
          tar -xzf "$INSTALL_DIR/gitleaks.tar.gz" -C "$INSTALL_DIR" gitleaks
          chmod +x "$INSTALL_DIR/gitleaks"
          echo "$INSTALL_DIR" >> "$GITHUB_PATH"

      - name: Secret Scan (Gitleaks OSS)
        run: |
          gitleaks git \
            --redact \
            --baseline-path .gitleaks-baseline.json \
            --exit-code 1 \
            --report-format sarif \
            --report-path gitleaks.sarif

      - name: Filesystem Vulnerability Scan (Trivy)
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: '1'

  create-release:
    needs: security-gates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Resolve Release Tag
        id: release_tag
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi
          echo "value=$TAG" >> "$GITHUB_OUTPUT"

      - name: Build Release Artifact
        run: ./gradlew :arc-app:bootJar

      - name: Prepare Release Artifact Paths
        id: artifact
        run: |
          set -euo pipefail
          mkdir -p dist
          JAR_SOURCE="$(ls arc-app/build/libs/*.jar | head -n 1)"
          JAR_NAME="arc-reactor-${{ steps.release_tag.outputs.value }}.jar"
          JAR_PATH="dist/${JAR_NAME}"
          SBOM_PATH="${JAR_PATH}.sbom.cdx.json"
          CHECKSUMS_PATH="dist/sha256sums.txt"

          cp "$JAR_SOURCE" "$JAR_PATH"

          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"
          echo "sbom_path=$SBOM_PATH" >> "$GITHUB_OUTPUT"
          echo "checksums_path=$CHECKSUMS_PATH" >> "$GITHUB_OUTPUT"

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft "file:${{ steps.artifact.outputs.jar_path }}" \
            -o "cyclonedx-json=${{ steps.artifact.outputs.sbom_path }}"

      - name: Generate SHA256 Checksums
        run: |
          sha256sum \
            "${{ steps.artifact.outputs.jar_path }}" \
            "${{ steps.artifact.outputs.sbom_path }}" \
            > "${{ steps.artifact.outputs.checksums_path }}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign Release Blobs (keyless)
        run: |
          set -euo pipefail
          for file in \
            "${{ steps.artifact.outputs.jar_path }}" \
            "${{ steps.artifact.outputs.sbom_path }}" \
            "${{ steps.artifact.outputs.checksums_path }}"; do
            cosign sign-blob --yes \
              --output-signature "${file}.sig" \
              --output-certificate "${file}.pem" \
              "$file"
          done

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            ${{ steps.artifact.outputs.jar_path }}
            ${{ steps.artifact.outputs.sbom_path }}
            ${{ steps.artifact.outputs.checksums_path }}

      - name: Resolve Release Notes File
        id: notes
        run: |
          FILE="docs/en/releases/${{ steps.release_tag.outputs.value }}.md"
          if [ -f "$FILE" ]; then
            echo "has_file=true" >> "$GITHUB_OUTPUT"
            echo "file=$FILE" >> "$GITHUB_OUTPUT"
          else
            echo "has_file=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release From Docs
        if: steps.notes.outputs.has_file == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.value }}
          name: ${{ steps.release_tag.outputs.value }}
          body_path: ${{ steps.notes.outputs.file }}
          files: |
            dist/*
          draft: false
          prerelease: false

      - name: Create Release With Generated Notes
        if: steps.notes.outputs.has_file != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.value }}
          name: ${{ steps.release_tag.outputs.value }}
          generate_release_notes: true
          files: |
            dist/*
          draft: false
          prerelease: false
