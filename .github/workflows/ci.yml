name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  SAFETY_TEST_MAX_SECONDS: "120"
  UNIT_TEST_MAX_SECONDS: "90"
  INTEGRATION_TEST_MAX_SECONDS: "150"

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [ '21' ]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Agent Instruction Sync Guard
        run: bash scripts/ci/check-agent-doc-sync.sh

      - name: Docs Link & Package Index Guard
        run: python3 scripts/ci/check-doc-links.py

      - name: Default Config Alignment Guard
        run: python3 scripts/ci/check-default-config-alignment.py

      - name: Structural File-Size Guard
        run: bash scripts/ci/check-file-size-guard.sh

      - name: Build
        run: ./gradlew build -x test

      - name: Run Safety Gate Tests (Fail-Close)
        run: |
          DURATION_LABEL="safety gate suite" bash scripts/ci/run-with-duration-guard.sh "$SAFETY_TEST_MAX_SECONDS" \
            ./gradlew :arc-core:test :arc-web:test \
            --tests "com.arc.reactor.scheduler.DynamicSchedulerServicePolicyPipelineTest" \
            --tests "com.arc.reactor.scheduler.DynamicSchedulerServiceCronValidationTest" \
            --tests "com.arc.reactor.approval.JdbcPendingApprovalStoreCleanupTest" \
            --tests "com.arc.reactor.safety.ToolInvocationPathSafetyTest" \
            --tests "com.arc.reactor.controller.ApprovalControllerAuthTest" \
            --tests "com.arc.reactor.controller.SchedulerControllerAuthTest"

      - name: Run Tests (Duration Guard)
        run: DURATION_LABEL="unit test suite" bash scripts/ci/run-with-duration-guard.sh "$UNIT_TEST_MAX_SECONDS" ./gradlew test

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-java-${{ matrix.java }}
          path: |
            arc-core/build/reports/tests/
            arc-web/build/reports/tests/
            arc-slack/build/reports/tests/
            arc-discord/build/reports/tests/
            arc-line/build/reports/tests/
            arc-error-report/build/reports/tests/

  integration:
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        java: [ '21' ]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run Integration Tests (core + web, Duration Guard)
        run: DURATION_LABEL="integration api suite" bash scripts/ci/run-with-duration-guard.sh "$INTEGRATION_TEST_MAX_SECONDS" ./gradlew :arc-core:test :arc-web:test -PincludeIntegration --tests "com.arc.reactor.integration.*"

      - name: Verify External Integration Tests Are Excluded
        run: |
          if ls arc-core/build/test-results/test/TEST-com.arc.reactor.mcp.McpIntegrationTest*.xml >/dev/null 2>&1; then
            echo "::error::external integration tests were executed in integration gate"
            exit 1
          fi

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: integration-test-results-java-${{ matrix.java }}
          path: |
            arc-core/build/reports/tests/
            arc-web/build/reports/tests/

  docker:
    runs-on: ubuntu-latest
    needs: [build, integration]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build JAR
        run: ./gradlew bootJar -x test

      - name: Docker Build Smoke Test
        run: docker build -t arc-reactor:ci .
