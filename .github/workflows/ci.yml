name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  SAFETY_TEST_MAX_SECONDS: "120"
  INTEGRATION_TEST_MAX_SECONDS: "150"
  PRE_OPEN_MAX_SECONDS: "1200"
  CI_RUNTIME_BASE_URL: ""

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      ci_relevant: ${{ steps.filter.outputs.ci_relevant }}
      runtime_deploy: ${{ steps.filter.outputs.runtime_deploy }}
    steps:
      - uses: actions/checkout@v6

      - name: Detect Changed Paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ci_relevant:
              - 'arc-*/src/**'
              - 'arc-*/build.gradle.kts'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
              - 'buildSrc/**'
              - 'scripts/**'
              - 'Dockerfile'
              - '.dockerignore'
              - '.github/workflows/ci.yml'
              - '.github/workflows/security-baseline.yml'
              - '.github/workflows/release.yml'
              - '.github/actions/**'
            runtime_deploy:
              - 'Dockerfile'
              - '.dockerignore'
              - 'compose*.yml'
              - 'docker/**'
              - 'arc-*/src/main/**'
              - 'arc-*/src/main/resources/**'
              - 'arc-app/**'
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle.properties'
              - 'gradle/**'
              - 'buildSrc/**'
              - 'scripts/deploy/**'
              - '.github/workflows/release.yml'

  pre_open:
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' || needs.changes.outputs.ci_relevant == 'true'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Install Gitleaks (OSS CLI)
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.24.2"
          INSTALL_DIR="$RUNNER_TEMP/gitleaks"
          mkdir -p "$INSTALL_DIR"
          curl -sSL \
            "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            -o "$INSTALL_DIR/gitleaks.tar.gz"
          tar -xzf "$INSTALL_DIR/gitleaks.tar.gz" -C "$INSTALL_DIR" gitleaks
          chmod +x "$INSTALL_DIR/gitleaks"
          echo "$INSTALL_DIR" >> "$GITHUB_PATH"

      - name: Run Pre-Open Gate
        run: |
          set -euo pipefail
          args=()
          if [ -n "${CI_RUNTIME_BASE_URL}" ]; then
            args+=(--with-runtime --with-agent-e2e --base-url "${CI_RUNTIME_BASE_URL}")
          fi
          DURATION_LABEL="pre-open gate" bash scripts/ci/run-with-duration-guard.sh \
            "$PRE_OPEN_MAX_SECONDS" ./scripts/dev/pre-open-check.sh "${args[@]}"

  build:
    runs-on: ubuntu-latest
    needs: [changes, pre_open]
    if: github.event_name == 'push' || needs.changes.outputs.ci_relevant == 'true'

    strategy:
      matrix:
        java: [ '21' ]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Agent Instruction Sync Guard
        run: bash scripts/ci/check-agent-doc-sync.sh

      - name: Docs Link & Package Index Guard
        run: python3 scripts/ci/check-doc-links.py

      - name: Default Config Alignment Guard
        run: python3 scripts/ci/check-default-config-alignment.py

      - name: Structural File-Size Guard
        run: bash scripts/ci/check-file-size-guard.sh

      - name: Flyway Migration Immutability Guard
        run: bash scripts/ci/check-flyway-migration-immutability.sh

      - name: Build
        run: ./gradlew build -x test

      - name: Run Safety Gate Tests (Fail-Close)
        run: |
          DURATION_LABEL="safety gate suite" bash scripts/ci/run-with-duration-guard.sh "$SAFETY_TEST_MAX_SECONDS" \
            ./gradlew :arc-core:test :arc-web:test \
            --tests "com.arc.reactor.scheduler.DynamicSchedulerServicePolicyPipelineTest" \
            --tests "com.arc.reactor.scheduler.DynamicSchedulerServiceCronValidationTest" \
            --tests "com.arc.reactor.approval.JdbcPendingApprovalStoreCleanupTest" \
            --tests "com.arc.reactor.safety.ToolInvocationPathSafetyTest" \
            --tests "com.arc.reactor.controller.ApprovalControllerAuthTest" \
            --tests "com.arc.reactor.controller.SchedulerControllerAuthTest"

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results-java-${{ matrix.java }}
          path: |
            arc-core/build/reports/tests/
            arc-web/build/reports/tests/
            arc-slack/build/reports/tests/
            arc-error-report/build/reports/tests/

  integration:
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: github.event_name == 'push' || needs.changes.outputs.ci_relevant == 'true'

    strategy:
      matrix:
        java: [ '21' ]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run API Regression Flow Test (Duration Guard)
        run: |
          DURATION_LABEL="api regression flow" bash scripts/ci/run-with-duration-guard.sh "120" \
            ./gradlew :arc-web:test -PincludeIntegration \
            --tests "com.arc.reactor.integration.ApiRegressionFlowIntegrationTest"

      - name: Run Integration Tests (core + web, Duration Guard)
        run: DURATION_LABEL="integration api suite" bash scripts/ci/run-with-duration-guard.sh "$INTEGRATION_TEST_MAX_SECONDS" ./gradlew :arc-core:test :arc-web:test -PincludeIntegration --tests "com.arc.reactor.integration.*"

      - name: Verify External Integration Tests Are Excluded
        run: |
          if ls arc-core/build/test-results/test/TEST-com.arc.reactor.mcp.McpIntegrationTest*.xml >/dev/null 2>&1; then
            echo "::error::external integration tests were executed in integration gate"
            exit 1
          fi

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: integration-test-results-java-${{ matrix.java }}
          path: |
            arc-core/build/reports/tests/
            arc-web/build/reports/tests/

  docker:
    runs-on: ubuntu-latest
    needs: [changes, build, integration]
    if: github.event_name == 'push' || needs.changes.outputs.runtime_deploy == 'true'

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build JAR
        run: ./gradlew bootJar -x test

      - name: Docker Build Smoke Test
        run: docker build -t arc-reactor:ci .
